<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Touch Drag Test</title>
<style>
body { font-family: sans-serif; padding: 20px; margin: 0; }
.item { padding: 16px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; gap: 12px; user-select: none; transition: all 0.1s; }
.item.picked { background: #DBEAFE; opacity: 0.4; }
.item.over { border-top: 3px solid #2563EB; }
.handle { font-size: 20px; color: #999; padding: 4px 8px; }
#log { margin-top: 20px; padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; }
</style>
</head><body>
<h3>タッチドラッグテスト</h3>
<p style="font-size:13px;color:#666">行を長押し(0.3秒)→スライド→離す</p>
<div id="list"></div>
<div id="log">ログ:</div>

<script>
const items = ["土地代", "建築費", "家賃収入", "管理費", "利回り"];
let pickedIdx = null;
let overIdx = null;
let timer = null;
let active = false;
const refs = [];

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += "\n" + msg;
  el.scrollTop = el.scrollHeight;
}

function render() {
  const list = document.getElementById("list");
  list.innerHTML = "";
  refs.length = 0;
  items.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "item" + (pickedIdx === i ? " picked" : "") + (overIdx === i && pickedIdx !== null && pickedIdx !== i ? " over" : "");
    div.innerHTML = '<span class="handle">⠿</span><span>' + item + '</span>';
    
    div.addEventListener("touchstart", (e) => {
      log("touchstart: " + i);
      timer = setTimeout(() => {
        active = true;
        pickedIdx = i;
        overIdx = i;
        log("PICKED: " + i + " (" + items[i] + ")");
        if (navigator.vibrate) navigator.vibrate(30);
        document.body.style.overflow = "hidden";
        render();
      }, 300);
    }, { passive: true });

    div.addEventListener("touchmove", (e) => {
      if (!active) {
        clearTimeout(timer);
        return;
      }
      e.preventDefault();
      const y = e.touches[0].clientY;
      let found = null;
      refs.forEach((el, idx) => {
        if (!el) return;
        const r = el.getBoundingClientRect();
        if (y >= r.top && y <= r.bottom) found = idx;
      });
      if (found !== null && found !== overIdx) {
        overIdx = found;
        log("over: " + found + " (" + items[found] + ")");
        render();
      }
    }, { passive: false });

    div.addEventListener("touchend", () => {
      clearTimeout(timer);
      log("touchend: picked=" + pickedIdx + " over=" + overIdx);
      if (active && pickedIdx !== null && overIdx !== null && pickedIdx !== overIdx) {
        const [moved] = items.splice(pickedIdx, 1);
        items.splice(overIdx, 0, moved);
        log("MOVED! " + moved + " → position " + overIdx);
      }
      active = false;
      pickedIdx = null;
      overIdx = null;
      document.body.style.overflow = "";
      render();
    });

    list.appendChild(div);
    refs.push(div);
  });
}

render();
</script>
</body></html>
